<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lottery Pack Scanner Log</title>
  <style>
    :root { --border:#ddd; --bg:#fafafa; }
    body { font-family: Arial, sans-serif; margin: 14px; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .small { font-size: 12px; color: #444; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0; }
    input, select, button { padding: 10px; font-size: 16px; }
    button { cursor:pointer; border-radius: 10px; border: 1px solid #bbb; background:#fff; }
    button.primary { border-color:#000; font-weight:700; }
    button.active { border-color:#000; font-weight:800; }
    .danger { color:#b00020; font-weight:700; }

    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid var(--border); padding: 8px; font-size: 14px; vertical-align: middle; }
    th { background: #f5f5f5; position: sticky; top: 0; z-index: 1; }
    td input[type="text"] { width: 100%; box-sizing: border-box; font-size: 16px; padding: 10px; }
    td input[type="number"] { width: 92px; }
    .right { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    /* Manager-only columns hidden by default */
    .mgr-only { display: none; }
    body.manager .mgr-only { display: table-cell; }

    /* Optional: hide row label on very small screens */
    @media (max-width: 560px) {
      th.col-row, td.col-row { display:none; }
      th, td { font-size: 13px; padding: 6px; }
      td input[type="text"] { font-size: 16px; }
    }

    .totals { margin-top: 10px; display: flex; gap: 14px; flex-wrap: wrap; }
    .card { border: 1px solid var(--border); padding: 10px; border-radius: 12px; background: var(--bg); min-width: 160px; }
    .big { font-size: 22px; font-weight: 800; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid #ccc; border-radius:999px; font-size:12px; background:#fff; }
  </style>
</head>
<body>
  <h1>Lottery Pack Scanner Log</h1>
  <div class="small">
    Scanner friendly: scan + Enter jumps to next row. Default view hides Price / Book Size / New Book.
    Export CSV includes hidden details for sharing.
  </div>

  <div class="row">
    <label class="small">Date<br>
      <input id="dateInput" type="date">
    </label>

    <button id="modeStart" class="active" type="button">Start (Morning)</button>
    <button id="modeEnd" type="button">End (Close)</button>

    <button id="btnManager" class="primary" type="button">Manager</button>

    <button id="btnSave" type="button">Save</button>
    <button id="btnLoad" type="button">Load</button>
    <button id="btnExport" type="button">Export CSV</button>
  </div>

  <div class="row">
    <label class="small">Note (optional)<br>
      <input id="noteInput" type="text" placeholder="Employee / shift / notes" style="min-width:300px;">
    </label>
    <span id="mgrStatus" class="pill">Manager: OFF</span>
  </div>

  <table>
    <thead>
      <tr>
        <th class="col-row" style="width:70px;">Row</th>

        <!-- Manager-only (hidden by default) -->
        <th class="mgr-only" style="width:95px;">Price $</th>
        <th class="mgr-only" style="width:120px;">Book Size</th>
        <th class="mgr-only" style="width:120px;">New Book?</th>

        <th>Starting Scan</th>
        <th style="width:95px;">Start #</th>
        <th>Ending Scan</th>
        <th style="width:95px;">End #</th>

        <th style="width:85px;">Sold</th>
        <th style="width:120px;">Sold $</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="totals">
    <div class="card">
      <div class="small">Total Tickets Sold</div>
      <div id="totalSold" class="big">0</div>
    </div>
    <div class="card">
      <div class="small">Total $ Sold</div>
      <div id="totalDollars" class="big">$0.00</div>
    </div>
    <div class="card">
      <div class="small">Status</div>
      <div id="status" class="mono">Ready.</div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // MANAGER PIN (your request)
  // =========================
  const MANAGER_PIN = "6349";

  // =========================
  // Default rows (24 rows)
  // =========================
  const DEFAULT_ROWS = [
    { label: "#1", price: 50 }, { label: "#2", price: 50 },
    { label: "#3", price: 30 }, { label: "#4", price: 30 }, { label: "#5", price: 30 },
    { label: "#6", price: 20 }, { label: "#7", price: 20 }, { label: "#8", price: 20 }, { label: "#9", price: 20 }, { label: "#10", price: 20 },
    { label: "#11", price: 10 }, { label: "#12", price: 10 }, { label: "#13", price: 10 }, { label: "#14", price: 10 },
    { label: "#15", price: 5 }, { label: "#16", price: 5 }, { label: "#17", price: 5 }, { label: "#18", price: 5 }, { label: "#19", price: 5 }, { label: "#20", price: 5 },
    { label: "#21", price: 2 }, { label: "#22", price: 2 }, { label: "#23", price: 2 }, { label: "#24", price: 2 },
  ];

  // Price -> default book size mapping (used when no override is set)
  const BOOK_SIZE_BY_PRICE = { 50:20, 30:20, 20:30, 10:60, 5:100, 2:200, 1:300 };

  // Storage keys
  const KEY_CONFIG = "lotteryScanConfig_v3"; // prices + book overrides
  const KEY_DAYS   = "lotteryScanDays_v3";   // per-day scans + totals

  // =========================
  // State
  // =========================
  let mode = "start";     // "start" or "end"
  let isManager = false;  // manager view

  // Each row keeps hidden values (price, bookSizeOverride, forceNewBook)
  let rows = loadConfig() || DEFAULT_ROWS.map(r => ({
    label: r.label,
    price: r.price,
    bookSizeOverride: null, // number or null (auto)
    forceNewBook: null,     // null=auto, true/false forced (manager-only)
    startScan: "",
    endScan: ""
  }));

  // =========================
  // DOM
  // =========================
  const tbody       = document.getElementById("tbody");
  const dateInput   = document.getElementById("dateInput");
  const noteInput   = document.getElementById("noteInput");
  const totalSoldEl = document.getElementById("totalSold");
  const totalDolEl  = document.getElementById("totalDollars");
  const statusEl    = document.getElementById("status");
  const mgrStatusEl = document.getElementById("mgrStatus");

  const btnSave    = document.getElementById("btnSave");
  const btnLoad    = document.getElementById("btnLoad");
  const btnExport  = document.getElementById("btnExport");
  const btnManager = document.getElementById("btnManager");

  const modeStartBtn = document.getElementById("modeStart");
  const modeEndBtn   = document.getElementById("modeEnd");

  // Default date = today
  dateInput.valueAsDate = new Date();

  // =========================
  // Helpers
  // =========================
  function setStatus(msg, isError=false) {
    statusEl.textContent = msg;
    statusEl.classList.toggle("danger", !!isError);
  }

  function digitsOnly(s) {
    return (s || "").toString().replace(/\D/g, "");
  }

  // Ticket number extraction: take LAST 3 digits (robust for hyphens/spaces)
  function parseTicketNumber(scanText) {
    const d = digitsOnly(scanText);
    if (d.length < 3) return null;
    const n = parseInt(d.slice(-3), 10);
    return Number.isFinite(n) ? n : null;
  }

  function pad3(n) {
    const s = String(n);
    return s.length >= 3 ? s : ("000" + s).slice(-3);
  }

  function money(n) {
    return "$" + (Number(n || 0)).toFixed(2);
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function csv(v) {
    const s = (v == null) ? "" : String(v);
    if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  function downloadText(text, filename, mime) {
    const blob = new Blob([text], { type: mime || "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function dayKey() {
    return dateInput.value || new Date().toISOString().slice(0,10);
  }

  function loadDays() {
    try { return JSON.parse(localStorage.getItem(KEY_DAYS) || "{}"); }
    catch { return {}; }
  }

  function saveDays(days) {
    localStorage.setItem(KEY_DAYS, JSON.stringify(days));
  }

  // =========================
  // Book Size + Sold formulas
  // =========================
  function bookSizeForRow(r) {
    const override = Number(r.bookSizeOverride);
    if (Number.isFinite(override) && override > 0) return override;

    const p = Number(r.price);
    return BOOK_SIZE_BY_PRICE[p] || 60; // fallback
  }

  function computeSold(startNo, endNo, bookSize, forceNewBook) {
    if (startNo == null || endNo == null) return { sold: null, newBook: false };

    const autoNewBook = startNo > endNo;
    const newBook = (forceNewBook === null) ? autoNewBook : !!forceNewBook;

    let sold = newBook ? ((bookSize - startNo) + endNo) : (endNo - startNo);
    if (!Number.isFinite(sold) || sold < 0) sold = null;

    return { sold, newBook };
  }

  function computeTotals() {
    let totalSold = 0;
    let totalDollars = 0;

    rows.forEach(r => {
      const startNo = parseTicketNumber(r.startScan);
      const endNo   = parseTicketNumber(r.endScan);
      const bs      = bookSizeForRow(r);
      const { sold } = computeSold(startNo, endNo, bs, r.forceNewBook);
      if (sold != null) {
        totalSold += sold;
        totalDollars += sold * Number(r.price || 0);
      }
    });

    return { totalSold, totalDollars };
  }

  // =========================
  // Config save/load (prices + book overrides)
  // =========================
  function saveConfig() {
    const config = rows.map(r => ({
      label: r.label,
      price: Number(r.price) || 0,
      bookSizeOverride: (r.bookSizeOverride == null || r.bookSizeOverride === "") ? null : Number(r.bookSizeOverride)
    }));
    localStorage.setItem(KEY_CONFIG, JSON.stringify(config));
  }

  function loadConfig() {
    try {
      const raw = localStorage.getItem(KEY_CONFIG);
      if (!raw) return null;
      const cfg = JSON.parse(raw);

      return DEFAULT_ROWS.map((d, i) => ({
        label: (cfg[i] && cfg[i].label) ? cfg[i].label : d.label,
        price: (cfg[i] && cfg[i].price != null) ? cfg[i].price : d.price,
        bookSizeOverride: (cfg[i] && cfg[i].bookSizeOverride != null) ? cfg[i].bookSizeOverride : null,
        forceNewBook: null,
        startScan: "",
        endScan: ""
      }));
    } catch {
      return null;
    }
  }

  // =========================
  // Manager mode
  // =========================
  function setManager(on) {
    isManager = !!on;
    document.body.classList.toggle("manager", isManager);
    mgrStatusEl.textContent = `Manager: ${isManager ? "ON" : "OFF"}`;
    setStatus(isManager ? "Manager view enabled (edit Price / Book Size / New Book)." : "Manager view disabled.");
    render();
  }

  function toggleManager() {
   _toggle:
    if (isManager) { setManager(false); return; }
    const pin = prompt("Enter Manager PIN:");
    if (pin === null) return;
    if (pin !== MANAGER_PIN) { setStatus("Wrong PIN.", true); return; }
    setManager(true);
  }

  // =========================
  // Mode (Start/End) scanning
  // =========================
  function setMode(nextMode) {
    mode = nextMode;
    modeStartBtn.classList.toggle("active", mode === "start");
    modeEndBtn.classList.toggle("active", mode === "end");
    setStatus(mode === "start" ? "Morning: scan Starting Scan column." : "Close: scan Ending Scan column.");
    focusFirstScan();
  }

  function focusFirstScan() {
    const k = (mode === "start") ? "startScan" : "endScan";
    const first = tbody.querySelector(`input[data-k="${k}"]`);
    if (first) { first.focus(); first.select(); }
  }

  function focusNextScanField(currentEl) {
    const k = (mode === "start") ? "startScan" : "endScan";
    const inputs = Array.from(tbody.querySelectorAll(`input[data-k="${k}"]`));
    const idx = inputs.indexOf(currentEl);
    const next = inputs[idx + 1] || inputs[0];
    next.focus();
    next.select();
  }

  // =========================
  // Render
  // =========================
  function render() {
    tbody.innerHTML = "";

    rows.forEach((r, idx) => {
      const startNo = parseTicketNumber(r.startScan);
      const endNo   = parseTicketNumber(r.endScan);
      const bs      = bookSizeForRow(r);
      const { sold, newBook } = computeSold(startNo, endNo, bs, r.forceNewBook);
      const soldDol = (sold == null) ? null : sold * Number(r.price || 0);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono col-row">${escapeHtml(r.label)}</td>

        <!-- Manager-only columns -->
        <td class="mgr-only right">
          <input type="number" step="1" min="0" data-k="price" data-i="${idx}" value="${Number(r.price || 0)}" />
        </td>

        <td class="mgr-only right">
          <input type="number" step="1" min="0" data-k="bookSizeOverride" data-i="${idx}"
                 value="${r.bookSizeOverride == null ? "" : Number(r.bookSizeOverride)}"
                 placeholder="auto" />
          <div class="small">auto uses mapping</div>
        </td>

        <td class="mgr-only right">
          <select data-k="forceNewBook" data-i="${idx}">
            <option value="auto"${r.forceNewBook === null ? " selected" : ""}>auto</option>
            <option value="true"${r.forceNewBook === true ? " selected" : ""}>true</option>
            <option value="false"${r.forceNewBook === false ? " selected" : ""}>false</option>
          </select>
          <div class="small">${newBook ? "wrap" : ""}</div>
        </td>

        <td>
          <input class="mono" type="text" data-k="startScan" data-i="${idx}" placeholder="scan"
                 value="${escapeHtml(r.startScan || "")}" />
        </td>
        <td class="right mono">${startNo == null ? "" : pad3(startNo)}</td>

        <td>
          <input class="mono" type="text" data-k="endScan" data-i="${idx}" placeholder="scan"
                 value="${escapeHtml(r.endScan || "")}" />
        </td>
        <td class="right mono">${endNo == null ? "" : pad3(endNo)}</td>

        <td class="right mono">${sold == null ? "" : sold}</td>
        <td class="right mono">${soldDol == null ? "" : money(soldDol)}</td>
      `;

      tbody.appendChild(tr);
    });

    wireInputs();
    updateTotalsUI();
  }

  function updateTotalsUI() {
    const { totalSold, totalDollars } = computeTotals();
    totalSoldEl.textContent = totalSold;
    totalDolEl.textContent = money(totalDollars);
  }

  function wireInputs() {
    tbody.querySelectorAll("input,select").forEach(el => {
      el.addEventListener("input", onEdit);
      el.addEventListener("change", onEdit);

      // Scanner workflow: Enter -> next row (current mode column)
      if (el.tagName === "INPUT" && (el.dataset.k === "startScan" || el.dataset.k === "endScan")) {
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            focusNextScanField(el);
          }
        });
      }
    });
  }

  function onEdit(e) {
    const i = Number(e.target.dataset.i);
    const k = e.target.dataset.k;
    if (!Number.isFinite(i) || !k) return;

    if (k === "price") {
      rows[i].price = Number(e.target.value || 0);
      saveConfig();
    } else if (k === "bookSizeOverride") {
      const v = e.target.value;
      rows[i].bookSizeOverride = (v === "" || v == null) ? null : Number(v);
      saveConfig();
    } else if (k === "forceNewBook") {
      const v = e.target.value;
      rows[i].forceNewBook = (v === "auto") ? null : (v === "true");
    } else if (k === "startScan" || k === "endScan") {
      rows[i][k] = e.target.value;
    }

    render();
  }

  // =========================
  // Save / Load (per day)
  // =========================
  function saveDay() {
    const key = dayKey();
    const days = loadDays();
    const totals = computeTotals();

    days[key] = {
      date: key,
      note: noteInput.value || "",
      savedAt: new Date().toISOString(),
      rows: rows.map(r => ({
        label: r.label,
        price: Number(r.price || 0),
        bookSizeOverride: r.bookSizeOverride,
        forceNewBook: r.forceNewBook,
        startScan: r.startScan || "",
        endScan: r.endScan || ""
      })),
      totals
    };

    saveDays(days);
    setStatus(`Saved ${key}.`);
  }

  function loadDay() {
    const key = dayKey();
    const days = loadDays();
    if (!days[key]) { setStatus(`No saved record for ${key}.`, true); return; }

    const payload = days[key];
    noteInput.value = payload.note || "";

    // Keep current config structure; load scans and also stored values if present
    rows = DEFAULT_ROWS.map((d, i) => {
      const current = rows[i] || {};
      const src = (payload.rows && payload.rows[i]) ? payload.rows[i] : null;

      return {
        label: current.label || d.label,
        price: (src && src.price != null) ? src.price : (current.price || d.price),
        bookSizeOverride: (src && "bookSizeOverride" in src) ? src.bookSizeOverride : (current.bookSizeOverride ?? null),
        forceNewBook: (src && "forceNewBook" in src) ? src.forceNewBook : null,
        startScan: (src && src.startScan) ? src.startScan : "",
        endScan: (src && src.endScan) ? src.endScan : ""
      };
    });

    setStatus(`Loaded ${key} (saved ${payload.savedAt}).`);
    render();
    focusFirstScan();
  }

  // =========================
  // Export CSV (includes hidden columns)
  // =========================
  function exportCSV() {
    const key = dayKey();
    const header = [
      "date","row","price","book_size_used","new_book","start_scan","start_no","end_scan","end_no","sold","sold_dollars","note"
    ];
    const lines = [header.join(",")];

    let totalSold = 0;
    let totalDollars = 0;

    rows.forEach(r => {
      const startNo = parseTicketNumber(r.startScan);
      const endNo   = parseTicketNumber(r.endScan);
      const bs      = bookSizeForRow(r);
      const { sold, newBook } = computeSold(startNo, endNo, bs, r.forceNewBook);

      const soldDollars = (sold == null) ? "" : (sold * Number(r.price || 0)).toFixed(2);

      if (sold != null) {
        totalSold += sold;
        totalDollars += sold * Number(r.price || 0);
      }

      lines.push([
        key,
        csv(r.label),
        Number(r.price || 0),
        bs,
        newBook ? "TRUE" : "FALSE",
        csv(r.startScan || ""),
        startNo == null ? "" : pad3(startNo),
        csv(r.endScan || ""),
        endNo == null ? "" : pad3(endNo),
        sold == null ? "" : sold,
        soldDollars,
        csv(noteInput.value || "")
      ].join(","));
    });

    lines.push(`TOTALS,,,,,,,,,${totalSold},${totalDollars.toFixed(2)},`);
    downloadText(lines.join("\n"), `lottery_${key}.csv`, "text/csv");
    setStatus(`Exported CSV for ${key}.`);
  }

  // =========================
  // Wire top buttons
  // =========================
  btnSave.addEventListener("click", saveDay);
  btnLoad.addEventListener("click", loadDay);
  btnExport.addEventListener("click", exportCSV);

  btnManager.addEventListener("click", toggleManager);
  modeStartBtn.addEventListener("click", () => setMode("start"));
  modeEndBtn.addEventListener("click", () => setMode("end"));

  // =========================
  // Init
  // =========================
  render();

  setMode("start");
  setManager(false);

})();
</script>
</body>
</html>
